{
  "name": "Review Reminder - Post Trip",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "cron-daily",
      "name": "Daily at 9 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  b.id,\n  b.reference,\n  b.\"checkOutDate\",\n  b.\"totalAmount\",\n  c.email as \"customerEmail\",\n  c.\"fullName\" as \"customerName\",\n  h.title as \"homestayTitle\",\n  h.slug as \"homestaySlug\"\nFROM \"Booking\" b\nINNER JOIN \"Customer\" c ON b.\"customerId\" = c.id\nLEFT JOIN \"Homestay\" h ON b.\"homestayId\" = h.id\nWHERE b.status = 'COMPLETED'\n  AND b.\"checkOutDate\" >= CURRENT_DATE - INTERVAL '7 days'\n  AND b.\"checkOutDate\" < CURRENT_DATE\n  AND NOT EXISTS (\n    SELECT 1 FROM \"HomestayReview\" hr \n    WHERE hr.\"bookingId\" = b.id\n  )\nLIMIT 50",
        "additionalFields": {}
      },
      "id": "postgres-query",
      "name": "Find Completed Bookings Without Reviews",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "3",
          "name": "PostgreSQL account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-has-bookings",
      "name": "Has Bookings?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "fromEmail": "noreply@conphungtourist.com",
        "toEmail": "={{ $json.customerEmail }}",
        "subject": "Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n t·∫°i {{ $json.homestayTitle }}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; border-radius: 8px 8px 0 0; }\n    .content { padding: 30px 20px; background: #f9fafb; }\n    .highlight { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n    .button { display: inline-block; padding: 14px 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 6px; margin: 20px 0; font-weight: 600; font-size: 16px; }\n    .stars { font-size: 24px; color: #fbbf24; }\n    .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>‚≠ê Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n</h1>\n    </div>\n    <div class=\"content\">\n      <p>Xin ch√†o <strong>{{ $json.customerName }}</strong>,</p>\n      \n      <p>C·∫£m ∆°n b·∫°n ƒë√£ l·ª±a ch·ªçn <strong>{{ $json.homestayTitle }}</strong> cho chuy·∫øn ƒëi c·ªßa m√¨nh!</p>\n      \n      <p>Ch√∫ng t√¥i hy v·ªçng b·∫°n ƒë√£ c√≥ nh·ªØng tr·∫£i nghi·ªám tuy·ªát v·ªùi. ƒê√°nh gi√° c·ªßa b·∫°n s·∫Ω gi√∫p ch√∫ng t√¥i c·∫£i thi·ªán d·ªãch v·ª• v√† gi√∫p nh·ªØng du kh√°ch kh√°c c√≥ th√™m th√¥ng tin khi l·ª±a ch·ªçn.</p>\n      \n      <div class=\"highlight\">\n        <p style=\"text-align: center; margin: 0;\"><strong>M√£ ƒë·∫∑t ph√≤ng:</strong> {{ $json.reference }}</p>\n        <p style=\"text-align: center; margin: 10px 0 0 0;\"><strong>Ng√†y tr·∫£ ph√≤ng:</strong> {{ $json.checkOutDate }}</p>\n      </div>\n      \n      <p><strong>Ch·ªâ m·∫•t 2 ph√∫t ƒë·ªÉ:</strong></p>\n      <ul style=\"padding-left: 20px;\">\n        <li>ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng d·ªãch v·ª•</li>\n        <li>Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n</li>\n        <li>Gi√∫p c·∫£i thi·ªán d·ªãch v·ª•</li>\n        <li>H·ªó tr·ª£ du kh√°ch kh√°c</li>\n      </ul>\n      \n      <div style=\"text-align: center;\">\n        <div class=\"stars\">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>\n        <a href=\"https://conphungtourist.com//homestays/{{ $json.homestaySlug }}?review=true&booking={{ $json.reference }}\" class=\"button\">Vi·∫øt ƒê√°nh Gi√° Ngay</a>\n      </div>\n      \n      <p style=\"margin-top: 30px; font-size: 14px; color: #6b7280;\">N·∫øu b·∫°n ƒë√£ vi·∫øt ƒë√°nh gi√°, xin vui l√≤ng b·ªè qua email n√†y. C·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu!</p>\n    </div>\n    <div class=\"footer\">\n      <p>Khu Du L·ªãch C·ªìn Ph·ª•ng</p>\n      <p>C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng ch√∫ng t√¥i! üå¥</p>\n    </div>\n  </div>\n</body>\n</html>"
      },
      "id": "email-review-request",
      "name": "Send Review Request Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [850, 200],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "üìä *Review Reminder Report*\n\n‚úÖ Sent {{ $json.length }} review reminder emails\n\nüìÖ Date: {{ $now.toFormat('yyyy-MM-dd') }}\n‚è∞ Time: {{ $now.toFormat('HH:mm') }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "telegram-report",
      "name": "Send Summary to Admin",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [850, 400],
      "credentials": {
        "telegramApi": {
          "id": "2",
          "name": "Telegram account"
        }
      }
    }
  ],
  "connections": {
    "Daily at 9 AM": {
      "main": [
        [
          {
            "node": "Find Completed Bookings Without Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Completed Bookings Without Reviews": {
      "main": [
        [
          {
            "node": "Has Bookings?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Bookings?": {
      "main": [
        [
          {
            "node": "Send Review Request Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Summary to Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "staticData": null,
  "tags": ["review", "reminder", "automation"],
  "triggerCount": 1,
  "updatedAt": "2025-01-22T00:00:00.000Z",
  "versionId": "1"
}
